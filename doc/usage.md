# Festivity Map CLI Usage Guide

> ðŸ¤– **Note:** This documentation was generated by GitHub Copilot and may contain errors or become outdated. Please verify commands and refer to `--help` flags for authoritative information.

This guide provides an overview of all CLI commands and how they fit together in the festivity mapping workflow.

## Overview

The festivity mapping workflow consists of several stages:

1. **Workspace Setup** - Initialize a workspace to store all data and models
2. **Model Training** - Train a classifier to detect festive decorations (one-time setup)
3. **Image Collection** - Add images with GPS data to your workspace
4. **GPS Extraction** - Extract GPS coordinates and address information
5. **Scoring** - Run the trained model to score images for festivity
6. **Visualization** - Generate interactive maps and view statistics

## Commands Reference

### `festivity init` - Initialize Workspace

**Purpose:** Create a new workspace with the required directory structure and configuration.

**Usage:**
```bash
festivity init <workspace_path> [--dinov3-repo PATH] [--weights-source PATH]
```

**Example:**
```bash
festivity init ~/festivity_workspace --dinov3-repo ./dinov3
```

**What it does:**
- Creates workspace directory structure (models/, outputs/, images/)
- Generates default `config.yaml` configuration file
- Creates empty SQLite database with required schema
- Optionally copies DINOv3 model weights

**When to use:** First step when starting a new festivity mapping project.

---

### `festivity train` - Train Festivity Classifier

**Purpose:** Train a machine learning classifier to detect festive decorations in images.

**Usage:**
```bash
festivity train --workspace <workspace> --images-dir <path> --labels-dir <path> [--skip-cv]
```

**Example:**
```bash
festivity train \
  --workspace ~/festivity_workspace \
  --images-dir ~/datasets/training/images \
  --labels-dir ~/datasets/training/labels \
  --skip-cv
```

**What it does:**
- Loads training images and corresponding label masks
- Extracts features using DINOv3 model
- Trains a logistic regression classifier
- Optionally performs cross-validation to find optimal parameters
- Saves trained model to `workspace/models/festivity_classifier.pkl`

**When to use:** 
- Once per workspace (unless retraining with new data)
- Requires labeled training data - see [labelling.md](labelling.md) for how to create labels

**Options:**
- `--skip-cv` - Skip cross-validation, use optimal_c from config.yaml
- `--save-plots` - Save precision-recall curves to outputs/training/

---

### `festivity add-images` - Add Images to Workspace

**Purpose:** Import images into the workspace for processing.

**Usage:**
```bash
festivity add-images --workspace <workspace> --images-dir <path> [--move]
```

**Example:**
```bash
festivity add-images \
  --workspace ~/festivity_workspace \
  --images-dir ~/photos/christmas_drive_2024
```

**What it does:**
- Copies (or moves) images from source directory to workspace/images/
- Validates that images contain `_left` or `_right` in filename
- Tracks which images have been added

**When to use:** 
- After collecting new images from camera
- Can be run multiple times to add batches incrementally

**Image naming requirement:** 
Images must contain `_left` or `_right` in the filename to indicate which side of the vehicle the camera was mounted (e.g., `IMG_1234_left.jpg`, `photo_0042_right.jpg`).

**Options:**
- `--move` - Move images instead of copying
- `--skip-duplicates` - Skip images that already exist in workspace

---

### `festivity extract-gps` - Extract GPS Data

**Purpose:** Extract GPS coordinates and timestamps from image EXIF data, calculate camera positions, and optionally fetch street addresses.

**Usage:**
```bash
festivity extract-gps --workspace <workspace> [--skip-address-fetch] [--force]
```

**Example:**
```bash
# With address fetching (requires internet)
festivity extract-gps --workspace ~/festivity_workspace

# Without addresses (faster, offline)
festivity extract-gps --workspace ~/festivity_workspace --skip-address-fetch
```

**What it does:**
- Reads GPS coordinates from image EXIF metadata
- Extracts timestamps for trajectory calculation
- Calculates vehicle heading based on GPS track
- Calculates offset camera positions (left/right of vehicle centerline)
- Optionally fetches street addresses from OpenStreetMap
- Stores all GPS data in database

**When to use:**
- After adding new images with `add-images`
- Only processes new images by default (use `--force` to reprocess all)

**Options:**
- `--skip-address-fetch` - Don't query OpenStreetMap for addresses
- `--force` - Reprocess all images, even those already in database

---

### `festivity score` - Score Images for Festivity

**Purpose:** Run the trained classifier on images to calculate festivity scores.

**Usage:**
```bash
festivity score --workspace <workspace> [--force] [--limit N]
```

**Example:**
```bash
# Score new images only
festivity score --workspace ~/festivity_workspace

# Rescore all images
festivity score --workspace ~/festivity_workspace --force

# Score only first 100 images (testing)
festivity score --workspace ~/festivity_workspace --limit 100
```

**What it does:**
- Loads the trained classifier from workspace/models/
- Processes images through DINOv3 feature extraction
- Calculates mean festivity probability for each image
- Stores scores in database

**When to use:**
- After extracting GPS data
- Only processes new images by default (use `--force` to rescore all)

**Requirements:**
- Must have run `festivity train` first
- Images must be in workspace/images/

**Options:**
- `--force` - Rescore all images, even those with existing scores
- `--limit N` - Only process first N images (useful for testing)
- `--save-visualizations` - Save heatmap visualizations to outputs/scores/

---

### `festivity trajectory-stats` - Calculate Trajectory Statistics

**Purpose:** Display statistics about the mapped trajectory including distance, duration, and speed.

**Usage:**
```bash
festivity trajectory-stats --workspace <workspace> [--gap-threshold SECONDS] [--min-distance METERS]
```

**Example:**
```bash
festivity trajectory-stats --workspace ~/festivity_workspace
```

**What it does:**
- Calculates total distance traveled
- Calculates total duration
- Computes average speed
- Counts unique addresses visited
- Detects and reports sub-trajectories (if gaps exist)
- Handles dual-camera setup (left/right cameras recording simultaneously)

**When to use:**
- After extracting GPS data
- To verify route quality and coverage

**Output includes:**
- Total images captured
- Total distance (km/mi)
- Total duration
- Average speed (km/h and mph)
- Number of unique addresses
- Sub-trajectory details (if route has gaps)

**Options:**
- `--gap-threshold SECONDS` - Max time gap before treating as new sub-trajectory (default: 10s)
- `--min-distance METERS` - Minimum movement to count as distance (filters GPS noise, default: 2.0m)

---

### `festivity map` - Generate Interactive Map

**Purpose:** Create an interactive HTML map showing festivity scores at different locations.

**Usage:**
```bash
festivity map --workspace <workspace> [--output PATH] [--show-addresses] [--deploy DIR]
```

**Example:**
```bash
# Generate map with default settings
festivity map --workspace ~/festivity_workspace

# Generate map with street addresses visible
festivity map --workspace ~/festivity_workspace --show-addresses

# Create deployment package for web hosting
festivity map --workspace ~/festivity_workspace --deploy ~/festivity_deploy
```

**What it does:**
- Queries database for all scored images with GPS data
- Creates interactive Folium map with:
  - Markers at each address showing festivity level
  - Image thumbnails in tooltips
  - GPS trajectory tracks (left/right camera paths)
  - Layer controls to toggle different elements
  - Trajectory statistics box
  - GPS location control (shows your current position)
- Saves HTML map to outputs/festivity_map.html

**When to use:**
- After scoring images
- Can be run multiple times with different settings

**Map features:**
- **Festivity categories:**
  - No lights detected (gray, hidden by default)
  - Some lights detected (dark red)
  - Moderate lights detected (orange)
  - Many lights detected (yellow)
- **Layers:**
  - Left/Right camera GPS tracks
  - Left/Right camera offset tracks
  - Festivity markers by category
- **Interactive elements:**
  - Click layer control to toggle elements
  - Click trajectory stats to expand/collapse
  - Hover over markers to see image preview
  - Click location button to show your GPS position

**Options:**
- `--output PATH` - Custom output path for HTML file
- `--show-addresses` - Show street addresses on map and in tooltips (privacy option)
- `--threshold FLOAT` - Probability threshold for "no lights" classification (default: 0.008)
- `--image-width PIXELS` - Width of thumbnail images (default: 200)
- `--deploy DIR` - Create self-contained deployment directory with resized images

**Deployment mode (`--deploy`):**
- Creates directory with festivity_map.html and images/ folder
- Resizes images to reduce file size (max 400px width, 85% quality)
- Ready to upload to Netlify, GitHub Pages, or any static hosting

---

### `festivity view` - Launch FiftyOne Visualization

**Purpose:** Open an interactive dataset viewer for exploring images, scores, and metadata.

**Usage:**
```bash
festivity view --workspace <workspace> [--port PORT]
```

**Example:**
```bash
festivity view --workspace ~/festivity_workspace
```

**What it does:**
- Creates FiftyOne dataset with all images and metadata
- Launches web-based viewer
- Allows filtering, sorting, and exploring data

**When to use:**
- For detailed data exploration
- To verify scores and GPS data
- To identify issues or outliers

**Options:**
- `--port PORT` - FiftyOne server port (default: 5151)

**Note:** Requires FiftyOne to be installed (`pip install fiftyone`)

---

## Complete Workflow Example

Here's a complete workflow from start to finish:

### 1. Initial Setup (One-time)

```bash
# Initialize workspace
festivity init ~/festivity_workspace --dinov3-repo ./dinov3

# Train model (requires labeled training data - see labelling.md)
festivity train \
  --workspace ~/festivity_workspace \
  --images-dir ~/training_data/images \
  --labels-dir ~/training_data/labels \
  --skip-cv
```

### 2. Process First Batch of Images

```bash
# Set workspace environment variable (optional, avoids --workspace flag)
export FESTIVITY_WORKSPACE=~/festivity_workspace

# Add images
festivity add-images --images-dir ~/photos/batch_001

# Extract GPS data
festivity extract-gps

# Score images
festivity score

# Generate map
festivity map
```

### 3. Add More Images (Incremental Processing)

```bash
# Add new batch
festivity add-images --images-dir ~/photos/batch_002

# Extract GPS (only processes new images)
festivity extract-gps

# Score (only processes new images)
festivity score

# Regenerate map (includes all images)
festivity map
```

### 4. View Statistics and Results

```bash
# Check trajectory statistics
festivity trajectory-stats

# Open interactive viewer (optional)
festivity view
```

### 5. Deploy to Web (Optional)

```bash
# Create deployment package
festivity map --deploy ~/festivity_deploy

# Upload ~/festivity_deploy to web hosting
# (Netlify, GitHub Pages, etc.)
```

---

## Configuration

The `config.yaml` file in your workspace controls various settings:

```yaml
# DINOv3 Model Settings
dinov3:
  model_type: "dinov3_vitl16"  # Model size
  repo_path: "/path/to/dinov3"  # Local DINOv3 repository

# GPS Processing Settings
gps:
  offset_distance_m: 20.0       # Camera offset from vehicle center
  min_heading_distance_m: 2.0   # Min distance for heading calculation
  address_match_distance_m: 30.0  # Max distance to match addresses

# Image Side Detection
image_patterns:
  left_pattern: "_left"   # Pattern for left camera images
  right_pattern: "_right"  # Pattern for right camera images

# Model Training Settings
training:
  optimal_c: 0.1          # Logistic regression regularization
  patch_size: 16
  image_size: 768
```

You can edit this file to customize behavior without modifying code.

---

## Tips and Best Practices

1. **Use environment variable for workspace:**
   ```bash
   export FESTIVITY_WORKSPACE=~/festivity_workspace
   ```
   Then you can omit `--workspace` from all commands.

2. **Process incrementally:**
   - Commands only process new data by default
   - Safe to run `extract-gps` and `score` multiple times
   - Use `--force` flag to reprocess everything

3. **Test on small subset first:**
   ```bash
   festivity score --limit 100  # Test on first 100 images
   ```

4. **Skip address fetching for faster processing:**
   ```bash
   festivity extract-gps --skip-address-fetch
   ```
   Can add addresses later by running without the flag.

5. **Check trajectory stats before generating map:**
   ```bash
   festivity trajectory-stats
   ```
   Helps verify GPS data quality.

6. **Privacy considerations:**
   - Don't use `--show-addresses` flag when sharing maps publicly
   - CartoDB Positron tiles (default) don't show street names
   - Use `--deploy` to create shareable package

7. **Model training:**
   - See [labelling.md](labelling.md) for detailed labeling instructions
   - Start with ~20-50 labeled images
   - More varied lighting conditions = better model

---

## Troubleshooting

**"No GPS data found"**
- Check that images have GPS EXIF data: `exiftool IMG_1234_left.jpg | grep GPS`
- Ensure images were taken with GPS-enabled camera

**"Cannot determine camera side"**
- Images must contain `_left` or `_right` in filename
- Check `config.yaml` image_patterns settings

**"Model not found"**
- Must run `festivity train` before `festivity score`
- Check that `workspace/models/festivity_classifier.pkl` exists

**"DINOv3 repository not found"**
- Verify `dinov3` directory exists at path in config.yaml
- Clone from: https://github.com/facebookresearch/dinov2

**Map shows no data**
- Ensure you've run: add-images â†’ extract-gps â†’ score
- Check that images have both GPS data and festivity scores in database

---

## Database Schema

All data is stored in `workspace/database.db` (SQLite):

- **gps_data** - GPS coordinates, timestamps, addresses
- **festivity_scores** - Festivity probability scores
- **images** - Image metadata and relationships

You can query directly with sqlite3 if needed:
```bash
sqlite3 ~/festivity_workspace/database.db "SELECT COUNT(*) FROM festivity_scores;"
```

---

## Additional Resources

- [labelling.md](labelling.md) - How to create training labels in GIMP
- [DINOv2 GitHub](https://github.com/facebookresearch/dinov2) - DINOv3 model repository
- [Folium Documentation](https://python-visualization.github.io/folium/) - Map library used for visualization
- [festivity_maps GitHub](https://github.com/tim-fan/festivity_maps) - Project repository
